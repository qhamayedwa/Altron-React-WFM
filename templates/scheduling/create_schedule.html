{% extends "base.html" %}

{% block title %}Create Schedule - Flask PostgreSQL App{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i data-feather="plus" class="me-2"></i>
            Create Employee Schedule
        </h2>
        <a href="{{ url_for('scheduling.manage_schedules') }}" class="btn btn-outline-secondary">
            <i data-feather="arrow-left" class="me-2"></i>
            Back to Schedules
        </a>
    </div>

    <div class="row">
        <!-- Employee Selection Panel -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="users" class="me-2"></i>
                        Department Employees
                    </h6>
                </div>
                <div class="card-body">
                    {% if users %}
                    <!-- Employee Search -->
                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i data-feather="search" width="14" height="14"></i>
                            </span>
                            <input type="text" class="form-control" id="employeeSearch" 
                                   placeholder="Search employees..." 
                                   onkeyup="searchEmployees(this.value)">
                        </div>
                    </div>
                    <!-- Batch Selection Controls -->
                    <div class="mb-3">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllEmployees()">
                                <i data-feather="check-square" width="14" height="14"></i>
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                <i data-feather="square" width="14" height="14"></i>
                                Clear All
                            </button>
                        </div>
                        <small class="text-muted">Click employees to select multiple for batch scheduling</small>
                    </div>

                    <div class="employee-list">
                        {% for user in users %}
                        <div class="employee-card mb-2 p-2 border rounded" 
                             data-user-id="{{ user.id }}" 
                             data-user-name="{{ user.full_name or user.username }}"
                             data-department="{{ user.department_name or 'Unassigned' }}"
                             onclick="toggleEmployee(this)">
                            <div class="d-flex align-items-center">
                                <div class="selection-checkbox me-2">
                                    <input type="checkbox" class="form-check-input employee-checkbox" 
                                           value="{{ user.id }}" id="emp_{{ user.id }}" onchange="updateEmployeeCard(this)">
                                </div>
                                <div class="avatar-initials me-2">
                                    {{ (user.first_name or user.username[:1])|upper }}{{ (user.last_name[:1] if user.last_name else '')|upper }}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">{{ user.full_name or user.username }}</div>
                                    <small class="text-muted">{{ user.department_name or 'Unassigned' }}</small>
                                    <div class="small text-success">
                                        <i data-feather="check-circle" width="12" height="12"></i>
                                        Available
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i data-feather="users" width="32" height="32" class="mb-2"></i>
                        <p class="mb-0">No employees found in your department</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Schedule Creation Form -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="calendar" class="me-2"></i>
                        Schedule Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="scheduleForm">
                        <!-- Selected Employees Display -->
                        <div id="selectedEmployeesInfo" class="alert alert-info d-none mb-3">
                            <div class="d-flex align-items-center">
                                <i data-feather="users" class="me-2"></i>
                                <div class="flex-grow-1">
                                    <strong>Selected Employees (<span id="selectedCount">0</span>):</strong>
                                    <div id="selectedEmployeesList" class="mt-1"></div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                    <i data-feather="x" width="14" height="14"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Hidden inputs for selected employees -->
                        <div id="selectedEmployeeInputs"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Batch Schedule Creation</label>
                                <div class="form-control-plaintext">
                                    <span id="batchModeIndicator" class="badge bg-secondary">Select employees from the left panel</span>
                                </div>
                                <div class="form-text">Multiple employees can be scheduled with the same time parameters</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shift_type_id" class="form-label">Shift Type</label>
                                <select class="form-select" id="shift_type_id" name="shift_type_id">
                                    <option value="">Custom Schedule</option>
                                    {% for shift_type in shift_types %}
                                    <option value="{{ shift_type.id }}" 
                                            data-start="{{ shift_type.default_start_time.strftime('%H:%M') }}"
                                            data-end="{{ shift_type.default_end_time.strftime('%H:%M') }}">
                                        {{ shift_type.name }} ({{ shift_type.default_start_time.strftime('%I:%M %p') }} - {{ shift_type.default_end_time.strftime('%I:%M %p') }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_datetime" class="form-label">Start Date & Time *</label>
                                <input type="datetime-local" class="form-control" id="start_datetime" name="start_datetime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_datetime" class="form-label">End Date & Time *</label>
                                <input type="datetime-local" class="form-control" id="end_datetime" name="end_datetime" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Any special instructions or notes for this schedule..."></textarea>
                        </div>

                        <div class="alert alert-info">
                            <i data-feather="info" class="me-2"></i>
                            <strong>Note:</strong> The system will check for scheduling conflicts before creating the schedule.
                            Employees will be notified of new schedule assignments.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('scheduling.manage_schedules') }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="save" class="me-2"></i>
                                Create Schedule
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Employee Selection Panel Styling */
.employee-card {
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.employee-card:hover {
    background: #e9ecef;
    border-color: #007bff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.employee-card.selected {
    background: #e3f2fd;
    border-color: #007bff !important;
    border-width: 2px !important;
}

.selection-checkbox {
    display: flex;
    align-items: center;
}

.employee-checkbox {
    cursor: pointer;
}

.selected-employee-tag {
    background: #e3f2fd;
    border: 1px solid #007bff;
    color: #0056b3;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    margin-right: 0.5rem;
    margin-bottom: 0.25rem;
    display: inline-block;
}

.avatar-initials {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.875rem;
}

.employee-list {
    max-height: 400px;
    overflow-y: auto;
}

.employee-list::-webkit-scrollbar {
    width: 6px;
}

.employee-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.employee-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.employee-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Schedule Form Enhancements */
.form-floating {
    position: relative;
}

.schedule-summary {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-left: 4px solid #007bff;
}

.time-display {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #007bff;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .employee-list {
        max-height: 200px;
    }
    
    .avatar-initials {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    let selectedEmployees = new Set();
    let employeeData = {};

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        setDefaultTimes();
        
        // Initialize employee data
        document.querySelectorAll('.employee-card').forEach(card => {
            const id = card.dataset.userId;
            employeeData[id] = {
                id: id,
                name: card.dataset.userName,
                department: card.dataset.department
            };
        });
    });

    // Toggle employee selection
    function toggleEmployee(card) {
        const checkbox = card.querySelector('.employee-checkbox');
        checkbox.checked = !checkbox.checked;
        updateEmployeeCard(checkbox);
    }

    // Update employee card based on checkbox state
    function updateEmployeeCard(checkbox) {
        const card = checkbox.closest('.employee-card');
        const userId = checkbox.value;
        
        if (checkbox.checked) {
            selectedEmployees.add(userId);
            card.classList.add('selected');
        } else {
            selectedEmployees.delete(userId);
            card.classList.remove('selected');
        }
        
        updateSelectedEmployeesDisplay();
    }

    // Select all employees
    function selectAllEmployees() {
        document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
            checkbox.checked = true;
            updateEmployeeCard(checkbox);
        });
        showNotification('All employees selected for batch scheduling', 'success');
    }

    // Clear all selections
    function clearSelection() {
        document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            updateEmployeeCard(checkbox);
        });
        showNotification('Selection cleared', 'info');
    }

    // Update the selected employees display
    function updateSelectedEmployeesDisplay() {
        const count = selectedEmployees.size;
        const infoPanel = document.getElementById('selectedEmployeesInfo');
        const countSpan = document.getElementById('selectedCount');
        const listDiv = document.getElementById('selectedEmployeesList');
        const inputsDiv = document.getElementById('selectedEmployeeInputs');
        const indicator = document.getElementById('batchModeIndicator');
        
        countSpan.textContent = count;
        
        if (count > 0) {
            infoPanel.classList.remove('d-none');
            
            // Update employee list display
            listDiv.innerHTML = '';
            selectedEmployees.forEach(id => {
                const employee = employeeData[id];
                const tag = document.createElement('span');
                tag.className = 'selected-employee-tag';
                tag.textContent = employee.name;
                listDiv.appendChild(tag);
            });
            
            // Update hidden inputs
            inputsDiv.innerHTML = '';
            selectedEmployees.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'user_ids[]';
                input.value = id;
                inputsDiv.appendChild(input);
            });
            
            // Update indicator
            if (count === 1) {
                indicator.textContent = `1 employee selected`;
                indicator.className = 'badge bg-primary';
            } else {
                indicator.textContent = `${count} employees selected for batch scheduling`;
                indicator.className = 'badge bg-success';
            }
        } else {
            infoPanel.classList.add('d-none');
            inputsDiv.innerHTML = '';
            indicator.textContent = 'Select employees from the left panel';
            indicator.className = 'badge bg-secondary';
        }
        
        feather.replace();
    }

    // Set default times when shift type is selected
    document.getElementById('shift_type_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const startTime = selectedOption.getAttribute('data-start');
        const endTime = selectedOption.getAttribute('data-end');
        
        if (startTime && endTime) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            // Set start datetime
            const startDateTime = tomorrow.toISOString().split('T')[0] + 'T' + startTime;
            document.getElementById('start_datetime').value = startDateTime;
            
            // Set end datetime (same day unless overnight shift)
            let endDate = tomorrow;
            if (endTime < startTime) { // Overnight shift
                endDate.setDate(tomorrow.getDate() + 1);
            }
            const endDateTime = endDate.toISOString().split('T')[0] + 'T' + endTime;
            document.getElementById('end_datetime').value = endDateTime;
            
            updateScheduleSummary();
        }
    });

    // Update schedule summary when times change
    function updateScheduleSummary() {
        const startInput = document.getElementById('start_datetime');
        const endInput = document.getElementById('end_datetime');
        
        if (startInput.value && endInput.value) {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);
            const duration = (end - start) / (1000 * 60 * 60); // hours
            
            // Update summary display if exists
            const summaryElement = document.getElementById('scheduleSummary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <strong>Duration:</strong> ${duration.toFixed(1)} hours<br>
                    <strong>Date:</strong> ${start.toLocaleDateString()}<br>
                    <strong>Time:</strong> ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                `;
            }
        }
    }

    // Add event listeners for time inputs
    ['start_datetime', 'end_datetime'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateScheduleSummary);
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const startDateTime = new Date(document.getElementById('start_datetime').value);
        const endDateTime = new Date(document.getElementById('end_datetime').value);
        
        if (selectedEmployees.size === 0) {
            e.preventDefault();
            showNotification('Please select at least one employee for scheduling.', 'warning');
            return false;
        }
        
        if (endDateTime <= startDateTime) {
            e.preventDefault();
            showNotification('End time must be after start time.', 'danger');
            return false;
        }
        
        const hoursDifference = (endDateTime - startDateTime) / (1000 * 60 * 60);
        if (hoursDifference > 24) {
            e.preventDefault();
            if (!confirm('This schedule is longer than 24 hours. Are you sure this is correct?')) {
                return false;
            }
        }
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i data-feather="clock" class="me-2"></i>Creating...';
        submitBtn.disabled = true;
    });

    // Set default start time to tomorrow 9 AM
    function setDefaultTimes() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        
        const defaultStart = tomorrow.toISOString().slice(0, 16);
        document.getElementById('start_datetime').value = defaultStart;
        
        // Set default end time to tomorrow 5 PM
        tomorrow.setHours(17, 0, 0, 0);
        const defaultEnd = tomorrow.toISOString().slice(0, 16);
        document.getElementById('end_datetime').value = defaultEnd;
        
        updateScheduleSummary();
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // Search employees
    function searchEmployees(query) {
        const cards = document.querySelectorAll('.employee-card');
        cards.forEach(card => {
            const name = card.dataset.userName.toLowerCase();
            const dept = card.dataset.department.toLowerCase();
            if (name.includes(query.toLowerCase()) || dept.includes(query.toLowerCase())) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}