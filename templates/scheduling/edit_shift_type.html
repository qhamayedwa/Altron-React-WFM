{% extends "base.html" %}

{% block title %}Edit Shift Type - Flask PostgreSQL App{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i data-feather="edit" class="me-2"></i>
            Edit Shift Type
        </h2>
        <a href="{{ url_for('scheduling.shift_types') }}" class="btn btn-outline-secondary">
            <i data-feather="arrow-left" class="me-2"></i>
            Back to Shift Types
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Shift Type Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Shift Name *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ shift_type.name if shift_type else '' }}"
                                       placeholder="e.g., Day, Evening, Night" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="description" class="form-label">Description</label>
                                <input type="text" class="form-control" id="description" name="description" 
                                       value="{{ shift_type.description if shift_type else '' }}"
                                       placeholder="Brief description of the shift">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="default_start_time" class="form-label">Default Start Time *</label>
                                <input type="time" class="form-control" id="default_start_time" name="default_start_time" 
                                       value="{{ shift_type.default_start_time.strftime('%H:%M') if shift_type and shift_type.default_start_time else '' }}"
                                       required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="default_end_time" class="form-label">Default End Time *</label>
                                <input type="time" class="form-control" id="default_end_time" name="default_end_time" 
                                       value="{{ shift_type.default_end_time.strftime('%H:%M') if shift_type and shift_type.default_end_time else '' }}"
                                       required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                           {{ 'checked' if shift_type and shift_type.is_active else '' }}>
                                    <label class="form-check-label" for="is_active">
                                        Active (uncheck to disable this shift type)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i data-feather="info" class="me-2"></i>
                            <strong>Note:</strong> Changes to default times will only affect new schedules created after this update. 
                            Existing schedules will retain their current times.
                        </div>

                        {% if shift_type and shift_type.id %}
                        <div class="alert alert-warning">
                            <i data-feather="alert-triangle" class="me-2"></i>
                            <strong>Usage Information:</strong>
                            <div class="mt-2">
                                <small class="text-muted">
                                    This shift type may be used in existing schedules. Disabling it will prevent new schedules 
                                    from using this type but won't affect existing ones.
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{{ url_for('scheduling.shift_types') }}" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                                {% if shift_type and shift_type.id %}
                                <button type="button" class="btn btn-outline-danger ms-2" onclick="confirmDelete()">
                                    <i data-feather="trash-2" class="me-2"></i>
                                    Delete
                                </button>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="save" class="me-2"></i>
                                Update Shift Type
                            </button>
                        </div>
                    </form>

                    {% if shift_type and shift_type.id %}
                    <!-- Hidden form for deletion -->
                    <form id="deleteForm" method="POST" action="{{ url_for('scheduling.delete_shift_type', shift_type_id=shift_type.id) }}" style="display: none;">
                        <input type="hidden" name="confirm_delete" value="1">
                    </form>
                    {% endif %}
                </div>
            </div>

            {% if shift_type and shift_type.id %}
            <!-- Usage Statistics -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="bar-chart" class="me-2"></i>
                        Usage Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 class="text-primary" id="active-schedules">-</h3>
                            <p class="text-muted mb-0">Active Schedules</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success" id="total-schedules">-</h3>
                            <p class="text-muted mb-0">Total Schedules</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-info" id="last-used">-</h3>
                            <p class="text-muted mb-0">Last Used</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    feather.replace();

    // Calculate duration when times change
    function updateDuration() {
        const startTime = document.getElementById('default_start_time').value;
        const endTime = document.getElementById('default_end_time').value;
        
        if (startTime && endTime) {
            const start = new Date('2000-01-01 ' + startTime);
            let end = new Date('2000-01-01 ' + endTime);
            
            // Handle overnight shifts
            if (end <= start) {
                end.setDate(end.getDate() + 1);
            }
            
            const diff = (end - start) / (1000 * 60 * 60); // Convert to hours
            console.log(`Shift duration: ${diff} hours`);
        }
    }

    function confirmDelete() {
        if (confirm('Are you sure you want to delete this shift type? This action cannot be undone.\n\nNote: This will only prevent new schedules from using this type. Existing schedules will not be affected.')) {
            document.getElementById('deleteForm').submit();
        }
    }

    // Load usage statistics if shift type exists
    document.addEventListener('DOMContentLoaded', function() {
        {% if shift_type and shift_type.id %}
        loadUsageStatistics({{ shift_type.id }});
        {% endif %}
    });

    function loadUsageStatistics(shiftTypeId) {
        fetch(`/scheduling/api/shift-type-stats/${shiftTypeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('active-schedules').textContent = data.stats.active_schedules || 0;
                    document.getElementById('total-schedules').textContent = data.stats.total_schedules || 0;
                    document.getElementById('last-used').textContent = data.stats.last_used || 'Never';
                }
            })
            .catch(error => {
                console.error('Error loading usage statistics:', error);
                document.getElementById('active-schedules').textContent = '?';
                document.getElementById('total-schedules').textContent = '?';
                document.getElementById('last-used').textContent = '?';
            });
    }

    document.getElementById('default_start_time').addEventListener('change', updateDuration);
    document.getElementById('default_end_time').addEventListener('change', updateDuration);
</script>
{% endblock %}