{% extends "base.html" %}

{% block title %}Edit Region - {{ region.name }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }
    .select2-container .select2-selection--single {
        height: 38px;
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    .select2-container .select2-selection--single .select2-selection__rendered {
        line-height: 24px;
    }
    .manager-details-card {
        background: #f8f9fa;
        border-left: 4px solid #27C1E3;
        padding: 15px;
        border-radius: 0 8px 8px 0;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-edit"></i> Edit Region - {{ region.name }}</h4>
                    <small class="text-muted">Company: {{ region.company.name }} ({{ region.company.code }})</small>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Region Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ region.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="code" class="form-label">Region Code *</label>
                                    <input type="text" class="form-control" id="code" name="code" 
                                           value="{{ region.code }}" required maxlength="10" style="text-transform: uppercase;">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ region.description or '' }}</textarea>
                        </div>

                        <hr>
                        <h5>Regional Management</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="manager_select" class="form-label">Regional Manager</label>
                                    <select class="form-control searchable-select" id="manager_select" name="manager_select">
                                        <option value="">Select a manager...</option>
                                        {% for manager in managers %}
                                        <option value="{{ manager.id }}" 
                                                data-name="{{ manager.full_name }}"
                                                data-email="{{ manager.email or '' }}"
                                                data-phone="{{ manager.phone_number or manager.mobile_number or '' }}"
                                                data-position="{{ manager.position or '' }}"
                                                data-department="{{ manager.department or '' }}"
                                                {% if manager.full_name == region.manager_name %}selected{% endif %}>
                                            {{ manager.full_name }} ({{ manager.employee_id }})
                                            {% if manager.position %} - {{ manager.position }}{% endif %}
                                            {% if manager.department %} - {{ manager.department }}{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Search by name, employee ID, or department</small>
                                </div>
                                <div class="mb-3">
                                    <label for="manager_name" class="form-label">Manager Name (Manual Entry)</label>
                                    <input type="text" class="form-control" id="manager_name" name="manager_name" 
                                           value="{{ region.manager_name or '' }}"
                                           placeholder="Or enter name manually if not in list">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ region.email or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="phone" name="phone" 
                                           value="{{ region.phone or '' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Manager Details Card (will be populated by JavaScript) -->
                        <div id="manager-details-card" class="manager-details-card" style="display: none;">
                            <h6><i class="fas fa-user"></i> Manager Details</h6>
                            <div id="manager-details-content"></div>
                        </div>

                        <hr>
                        <h5>Address Information</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="address_line1" class="form-label">Address Line 1</label>
                                    <input type="text" class="form-control" id="address_line1" name="address_line1" 
                                           value="{{ region.address_line1 or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="address_line2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="address_line2" name="address_line2" 
                                           value="{{ region.address_line2 or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" 
                                           value="{{ region.city or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="state_province" class="form-label">State/Province</label>
                                    <input type="text" class="form-control" id="state_province" name="state_province" 
                                           value="{{ region.state_province or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="postal_code" class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code" 
                                           value="{{ region.postal_code or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Timezone</label>
                                    <select class="form-control" id="timezone" name="timezone">
                                        <option value="Africa/Johannesburg" {% if region.timezone == 'Africa/Johannesburg' %}selected{% endif %}>South Africa Standard Time (SAST)</option>
                                        <option value="Africa/Cairo" {% if region.timezone == 'Africa/Cairo' %}selected{% endif %}>Central Africa Time (CAT)</option>
                                        <option value="Africa/Lagos" {% if region.timezone == 'Africa/Lagos' %}selected{% endif %}>West Africa Time (WAT)</option>
                                        <option value="UTC" {% if region.timezone == 'UTC' %}selected{% endif %}>Coordinated Universal Time (UTC)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h5>Status</h5>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if region.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    Region is Active
                                </label>
                                <small class="form-text text-muted d-block">Inactive regions will be hidden from most views</small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('organization.view_region', region_id=region.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Region
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for searchable manager dropdown
    $('.searchable-select').select2({
        placeholder: 'Search for a manager...',
        allowClear: true,
        width: '100%'
    });
    
    // Handle manager selection
    $('#manager_select').on('change', function() {
        const selectedOption = $(this).find(':selected');
        const managerId = $(this).val();
        
        if (managerId) {
            // Auto-populate manager details
            const managerName = selectedOption.data('name');
            const email = selectedOption.data('email');
            const phone = selectedOption.data('phone');
            const position = selectedOption.data('position');
            const department = selectedOption.data('department');
            
            $('#manager_name').val(managerName);
            $('#email').val(email || $('#email').val());
            $('#phone').val(phone || $('#phone').val());
            
            // Show manager details card
            let detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Name:</strong> ${managerName}<br>
                        ${position ? `<strong>Position:</strong> ${position}<br>` : ''}
                        ${department ? `<strong>Department:</strong> ${department}<br>` : ''}
                    </div>
                    <div class="col-md-6">
                        ${email ? `<strong>Email:</strong> ${email}<br>` : ''}
                        ${phone ? `<strong>Phone:</strong> ${phone}<br>` : ''}
                    </div>
                </div>
            `;
            
            $('#manager-details-content').html(detailsHtml);
            $('#manager-details-card').show();
            
            // Store manager ID for form submission
            $('<input>').attr({
                type: 'hidden',
                name: 'manager_id',
                value: managerId
            }).appendTo('form');
        } else {
            $('#manager-details-card').hide();
            $('input[name="manager_id"]').remove();
        }
    });
    
    // Convert region code to uppercase
    $('#code').on('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Clear manual manager name when dropdown selection is made
    $('#manager_select').on('change', function() {
        if ($(this).val()) {
            // Don't clear if we're populating from selection
        }
    });
    
    // Clear dropdown when manual name is entered
    $('#manager_name').on('input', function() {
        if ($(this).val()) {
            $('#manager_select').val(null).trigger('change');
            $('#manager-details-card').hide();
            $('input[name="manager_id"]').remove();
        }
    });
});
</script>
{% endblock %}