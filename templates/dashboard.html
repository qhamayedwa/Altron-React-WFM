{% extends "base.html" %}

{% block title %}Dashboard - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Dashboard</h2>
            <p class="text-muted mb-0">Welcome back, {{ current_user.username }}!</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <div class="badge bg-primary">{{ current_user.role }}</div>
            <div id="clockStatus" class="badge bg-secondary">
                {% if current_status and current_status.get('is_clocked_in') %}
                    <span class="badge bg-success">Clocked In</span>
                {% else %}
                    <span class="badge bg-secondary">Clocked Out</span>
                {% endif %}
            </div>
            <!-- Dashboard Controls -->
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary" id="editModeBtn" onclick="toggleEditMode()">
                    <i data-feather="edit-3" width="16" height="16"></i> Edit Layout
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetLayoutBtn" onclick="resetLayout()" style="display: none;">
                    <i data-feather="refresh-cw" width="16" height="16"></i> Reset
                </button>
                <button type="button" class="btn btn-outline-success" id="saveLayoutBtn" onclick="saveLayout()" style="display: none;">
                    <i data-feather="save" width="16" height="16"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Mode Notice -->
    <div id="editModeNotice" class="alert alert-info d-none mb-4">
        <div class="d-flex align-items-center">
            <i data-feather="info" class="me-2" width="20" height="20"></i>
            <div>
                <strong>Edit Mode Active:</strong> Drag and drop widgets to rearrange your dashboard. Click "Save" to keep your layout or "Reset" to restore defaults.
            </div>
        </div>
    </div>

    <!-- Moveable Dashboard Widgets -->
    <div id="dashboardGrid" class="sortable-grid mb-4">
        <!-- Widget: Today's Hours -->
        <div class="widget-container" data-widget-id="today-hours" data-widget-type="stat">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Today's Hours</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Today's Hours</h6>
                            <h3 class="card-title mb-0">
                                <a href="#" onclick="showDrillDown('today-hours')" class="text-decoration-none">
                                    {{ today_stats.total_hours|hours_minutes }}
                                </a>
                            </h3>
                            <small class="text-muted">Click to view breakdown</small>
                        </div>
                        <div class="text-primary">
                            <i data-feather="clock" class="feather-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: This Week -->
        <div class="widget-container" data-widget-id="week-hours" data-widget-type="stat">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">This Week</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">This Week</h6>
                            <h3 class="card-title mb-0">
                                <a href="#" onclick="showDrillDown('week-hours')" class="text-decoration-none">
                                    {{ week_stats.total_hours|hours_minutes }}
                                </a>
                            </h3>
                            <small class="text-muted">Click to view breakdown</small>
                        </div>
                        <div class="text-success">
                            <i data-feather="calendar" class="feather-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Leave Balance -->
        <div class="widget-container" data-widget-id="leave-balance" data-widget-type="stat">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Leave Balance</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Leave Balance</h6>
                            <h3 class="card-title mb-0">
                                <a href="#" onclick="showDrillDown('leave-balance')" class="text-decoration-none">
                                    {{ leave_balance.balance if leave_balance else '0' }}
                                </a>
                            </h3>
                            <small class="text-muted">days remaining • Click to view breakdown</small>
                        </div>
                        <div class="text-warning">
                            <i data-feather="calendar-x" class="feather-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Status -->
        <div class="widget-container" data-widget-id="status" data-widget-type="stat">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Status</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                            <h3 class="card-title mb-0">
                                {% if current_status and current_status.get('is_clocked_in') %}
                                    Active
                                {% else %}
                                    Idle
                                {% endif %}
                            </h3>
                        </div>
                        <div class="text-info">
                            <i data-feather="trending-up" class="feather-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manager/Super User Widgets -->
        {% if current_user.role in ['Manager', 'Super User'] %}
        
        <!-- Widget: Team Overview -->
        <div class="widget-container" data-widget-id="team-overview" data-widget-type="chart">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Team Overview</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">Team Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">
                                <a href="#" onclick="showDrillDown('total-staff')" class="text-decoration-none text-primary">
                                    {{ dashboard_data.user_stats.total_users or 0 }}
                                </a>
                            </h4>
                            <small class="text-muted">Total Staff</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">
                                <a href="#" onclick="showDrillDown('active-today')" class="text-decoration-none text-success">
                                    {{ dashboard_data.user_stats.active_users or 0 }}
                                </a>
                            </h4>
                            <small class="text-muted">Active Today</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">
                                <a href="#" onclick="showDrillDown('overtime-hours')" class="text-decoration-none text-warning">
                                    {{ dashboard_data.attendance_stats.total_overtime_hours or 0 }}
                                </a>
                            </h4>
                            <small class="text-muted">OT Hours</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Attendance Summary -->
        <div class="widget-container" data-widget-id="attendance-summary" data-widget-type="list">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Attendance Summary</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">Today's Attendance</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Present:</span>
                        <span class="badge bg-success">
                            <a href="#" onclick="showDrillDown('present-today')" class="text-decoration-none text-white">
                                {{ dashboard_data.attendance_stats.present_today or 0 }}
                            </a>
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Late:</span>
                        <span class="badge bg-warning">{{ dashboard_data.attendance_stats.late_today or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Absent:</span>
                        <span class="badge bg-danger">{{ dashboard_data.attendance_stats.absent_today or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>On Leave:</span>
                        <span class="badge bg-info">{{ dashboard_data.leave_stats.on_leave_today or 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

        {% if current_user.role == 'Super User' %}
        
        <!-- Widget: System Stats -->
        <div class="widget-container" data-widget-id="system-stats" data-widget-type="chart">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">System Statistics</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">System Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ dashboard_data.system_stats.total_organizations or 0 }}</h4>
                            <small class="text-muted">Organizations</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ dashboard_data.system_stats.total_departments or 0 }}</h4>
                            <small class="text-muted">Departments</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Payroll Summary -->
        <div class="widget-container" data-widget-id="payroll-summary" data-widget-type="financial">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Payroll Summary</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">This Month Payroll</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Hours:</span>
                        <span class="fw-bold">{{ dashboard_data.payroll_stats.total_hours or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Regular Pay:</span>
                        <span class="text-success">R {{ dashboard_data.payroll_stats.regular_pay or '0.00' }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Overtime Pay:</span>
                        <span class="text-warning">R {{ dashboard_data.payroll_stats.overtime_pay or '0.00' }}</span>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

        <!-- Common Widgets for All Users -->
        
        <!-- Widget: Recent Activity -->
        <div class="widget-container" data-widget-id="recent-activity" data-widget-type="activity">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Recent Activity</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-list">
                        {% if recent_time_entries %}
                            {% for entry in recent_time_entries[:3] %}
                            <div class="d-flex align-items-center mb-2">
                                <div class="flex-shrink-0">
                                    <div class="activity-dot bg-primary"></div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">{{ entry.clock_in_time.strftime('%H:%M') }}</small>
                                    <div class="fw-medium">{{ entry.work_date.strftime('%b %d') }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No recent activity</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Quick Actions -->
        <div class="widget-container" data-widget-id="quick-actions" data-widget-type="actions">
            <div class="card draggable-widget">
                <div class="widget-header d-none">
                    <i data-feather="move" class="drag-handle me-2"></i>
                    <span class="widget-title">Quick Actions</span>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if current_status and current_status.get('is_clocked_in') %}
                            <button class="btn btn-danger btn-sm" onclick="clockOut()">
                                <i data-feather="log-out" width="16" height="16"></i> Clock Out
                            </button>
                        {% else %}
                            <button class="btn btn-success btn-sm" onclick="clockIn()">
                                <i data-feather="log-in" width="16" height="16"></i> Clock In
                            </button>
                        {% endif %}
                        <a href="{{ url_for('leave_management.apply_leave') }}" class="btn btn-primary btn-sm">
                            <i data-feather="calendar" width="16" height="16"></i> Apply Leave
                        </a>
                        {% if current_user.role in ['Manager', 'Super User'] %}
                        <a href="{{ url_for('time_attendance.team_timecard') }}" class="btn btn-info btn-sm">
                            <i data-feather="users" width="16" height="16"></i> Team Cards
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- Quick Actions & Recent Activity -->
    <div class="row">
        <!-- Quick Actions -->
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Quick Actions</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleQuickActionsView()">
                        <i data-feather="grid" id="viewToggleIcon"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Self-Service Actions Grid -->
                    <div id="quickActionsGrid" class="d-grid gap-2">
                        <!-- Primary Time Tracking -->
                        <div class="quick-action-section">
                            <small class="text-muted mb-2 d-block">Time Tracking</small>
                            <div id="clockButtonContainer">
                            {% if current_status and current_status.get('is_clocked_in') %}
                            <form method="POST" action="/time/clock-out" style="display: inline;" onsubmit="return true;">
                                <button type="submit" class="btn btn-danger w-100 mb-2" id="clockOutBtn">
                                    <i data-feather="clock" class="me-2"></i>Clock Out
                                    <small class="d-block" id="clockInTime" data-iso-time="{{ current_status.get('clock_in_time') or '' }}">Started: {{ current_status.get('clock_in_time').split('T')[1].split('.')[0][:5] if current_status.get('clock_in_time') else 'Unknown' }}</small>
                                    <div class="live-timer mt-1">
                                        <strong class="text-white" id="liveDuration">00:00:00</strong>
                                        <small class="d-block opacity-75">Working Time</small>
                                    </div>
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="/time/clock-in" style="display: inline;" onsubmit="return true;">
                                <button type="submit" class="btn btn-success w-100 mb-2" name="clock_in" value="1">
                                    <i data-feather="clock" class="me-2"></i>Clock In
                                    <small class="d-block">Start your workday</small>
                                </button>
                            </form>
                            {% endif %}
                            </div>
                        </div>
                        
                        <!-- Employee Self-Service -->
                        <div class="quick-action-section">
                            <small class="text-muted mb-2 d-block">Self-Service</small>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="showTimesheet()">
                                        <i data-feather="calendar" class="me-1"></i>Timesheet
                                    </button>
                                </div>
                                <div class="col-6">
                                    <a href="{{ url_for('leave_management.apply_leave') }}" class="btn btn-outline-warning btn-sm w-100">
                                        <i data-feather="calendar-x" class="me-1"></i>Leave
                                    </a>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-info btn-sm w-100" onclick="showProfile()">
                                        <i data-feather="user" class="me-1"></i>Profile
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="showHelp()">
                                        <i data-feather="help-circle" class="me-1"></i>Help
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>

<style>
/* Moveable Dashboard Widgets Styling */
.sortable-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    min-height: 200px;
}

.widget-container {
    position: relative;
    transition: all 0.3s ease;
}

.draggable-widget {
    cursor: grab;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.draggable-widget:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.draggable-widget.dragging {
    cursor: grabbing;
    opacity: 0.8;
    transform: rotate(3deg);
    z-index: 1000;
    border: 2px dashed var(--bs-primary);
}

.widget-header {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-dark, #0056b3));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem 0.375rem 0 0;
    cursor: grab;
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
}

.widget-header:active {
    cursor: grabbing;
}

.drag-handle {
    cursor: grab;
    opacity: 0.7;
}

.drag-handle:hover {
    opacity: 1;
}

.sortable-placeholder {
    background: rgba(var(--bs-primary-rgb), 0.1);
    border: 2px dashed var(--bs-primary);
    border-radius: 0.375rem;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--bs-primary);
    font-weight: 500;
}

.sortable-placeholder::before {
    content: "Drop widget here";
    font-size: 0.875rem;
    opacity: 0.7;
}

/* Edit Mode Styling */
.edit-mode .widget-header {
    display: flex !important;
}

.edit-mode .draggable-widget {
    border: 2px solid rgba(var(--bs-primary-rgb), 0.3);
}

.edit-mode .sortable-grid {
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(var(--bs-primary-rgb), 0.05) 10px,
        rgba(var(--bs-primary-rgb), 0.05) 20px
    );
    padding: 1rem;
    border-radius: 0.5rem;
    border: 2px dashed rgba(var(--bs-primary-rgb), 0.3);
}

/* Activity Widget Styling */
.activity-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

.activity-list {
    max-height: 200px;
    overflow-y: auto;
}

/* Widget Type Indicators */
.widget-container[data-widget-type="stat"] .card {
    border-left: 4px solid var(--bs-primary);
}

.widget-container[data-widget-type="chart"] .card {
    border-left: 4px solid var(--bs-success);
}

.widget-container[data-widget-type="list"] .card {
    border-left: 4px solid var(--bs-info);
}

.widget-container[data-widget-type="financial"] .card {
    border-left: 4px solid var(--bs-warning);
}

.widget-container[data-widget-type="activity"] .card {
    border-left: 4px solid var(--bs-secondary);
}

.widget-container[data-widget-type="actions"] .card {
    border-left: 4px solid var(--bs-danger);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .sortable-grid {
        grid-template-columns: 1fr;
    }
    
    .widget-header {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation for layout changes */
.widget-container {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Dashboard Widget Management System
class DashboardManager {
    constructor() {
        this.isEditMode = false;
        this.sortable = null;
        this.originalLayout = [];
        this.init();
    }

    init() {
        // Initialize Feather Icons
        feather.replace();
        
        // Load saved layout
        this.loadLayout();
        
        // Initialize live timer if clocked in
        if (window.liveTimer) {
            window.liveTimer.init();
        }
        
        // Setup sortable functionality
        this.initSortable();
    }

    initSortable() {
        const grid = document.getElementById('dashboardGrid');
        if (!grid) return;

        this.sortable = new Sortable(grid, {
            animation: 150,
            disabled: true, // Start in view mode
            ghostClass: 'sortable-placeholder',
            chosenClass: 'dragging',
            dragClass: 'dragging',
            handle: '.drag-handle',
            onEnd: (evt) => {
                this.onWidgetMoved(evt);
            }
        });
    }

    toggleEditMode() {
        this.isEditMode = !this.isEditMode;
        const body = document.body;
        const editBtn = document.getElementById('editModeBtn');
        const resetBtn = document.getElementById('resetLayoutBtn');
        const saveBtn = document.getElementById('saveLayoutBtn');
        const notice = document.getElementById('editModeNotice');

        if (this.isEditMode) {
            // Enter edit mode
            body.classList.add('edit-mode');
            notice.classList.remove('d-none');
            editBtn.innerHTML = '<i data-feather="eye" width="16" height="16"></i> View Mode';
            resetBtn.style.display = 'inline-block';
            saveBtn.style.display = 'inline-block';
            this.sortable.option('disabled', false);
            
            // Store original layout
            this.storeOriginalLayout();
            
            this.showNotification('Edit mode activated. Drag widgets to rearrange.', 'info');
        } else {
            // Exit edit mode
            body.classList.remove('edit-mode');
            notice.classList.add('d-none');
            editBtn.innerHTML = '<i data-feather="edit-3" width="16" height="16"></i> Edit Layout';
            resetBtn.style.display = 'none';
            saveBtn.style.display = 'none';
            this.sortable.option('disabled', true);
        }
        
        feather.replace();
    }

    storeOriginalLayout() {
        const widgets = document.querySelectorAll('.widget-container');
        this.originalLayout = Array.from(widgets).map(widget => ({
            id: widget.dataset.widgetId,
            element: widget.cloneNode(true)
        }));
    }

    resetLayout() {
        if (!confirm('Are you sure you want to reset the dashboard to default layout?')) {
            return;
        }

        // Remove saved layout
        localStorage.removeItem(`dashboard_layout_${this.getUserRole()}`);
        
        // Reload page to get default layout
        window.location.reload();
    }

    saveLayout() {
        const widgets = document.querySelectorAll('.widget-container');
        const layout = Array.from(widgets).map((widget, index) => ({
            id: widget.dataset.widgetId,
            type: widget.dataset.widgetType,
            order: index
        }));

        // Save to localStorage with user role specificity
        const userRole = this.getUserRole();
        localStorage.setItem(`dashboard_layout_${userRole}`, JSON.stringify(layout));
        
        this.showNotification('Dashboard layout saved successfully!', 'success');
        this.toggleEditMode();
    }

    loadLayout() {
        const userRole = this.getUserRole();
        const savedLayout = localStorage.getItem(`dashboard_layout_${userRole}`);
        
        if (!savedLayout) return;

        try {
            const layout = JSON.parse(savedLayout);
            this.applyLayout(layout);
        } catch (error) {
            console.error('Failed to load dashboard layout:', error);
        }
    }

    applyLayout(layout) {
        const grid = document.getElementById('dashboardGrid');
        if (!grid) return;

        // Sort widgets according to saved order
        layout.sort((a, b) => a.order - b.order);
        
        layout.forEach(item => {
            const widget = document.querySelector(`[data-widget-id="${item.id}"]`);
            if (widget) {
                grid.appendChild(widget);
            }
        });
    }

    onWidgetMoved(evt) {
        // Update positions and provide feedback
        this.showNotification('Widget moved. Remember to save your layout!', 'info');
    }

    getUserRole() {
        // Extract user role from the page
        const roleElement = document.querySelector('.badge.bg-primary');
        return roleElement ? roleElement.textContent.trim().toLowerCase().replace(' ', '_') : 'employee';
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
}

// Global dashboard manager instance
let dashboardManager;

// Global functions for button events
function toggleEditMode() {
    dashboardManager.toggleEditMode();
}

function resetLayout() {
    dashboardManager.resetLayout();
}

function saveLayout() {
    dashboardManager.saveLayout();
}

// Clock in/out functions
async function clockIn() {
    try {
        const response = await fetch('/time/clock-in', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            dashboardManager.showNotification('Failed to clock in', 'danger');
        }
    } catch (error) {
        dashboardManager.showNotification('Clock in error', 'danger');
    }
}

async function clockOut() {
    try {
        const response = await fetch('/time/clock-out', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            dashboardManager.showNotification('Failed to clock out', 'danger');
        }
    } catch (error) {
        dashboardManager.showNotification('Clock out error', 'danger');
    }
}

// Quick Actions
function showTimesheet() {
    window.location.href = '/time/my-timecard';
}

function showProfile() {
    window.location.href = '/auth/profile';
}

function showHelp() {
    dashboardManager.showNotification('Help documentation coming soon!', 'info');
}

function toggleQuickActionsView() {
    const quickActions = document.getElementById('quickActionsGrid');
    if (quickActions) {
        quickActions.style.display = quickActions.style.display === 'none' ? 'block' : 'none';
    }
}

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    dashboardManager = new DashboardManager();
});

// Auto-refresh dashboard data every 5 minutes
setInterval(() => {
    // Refresh only specific data without full page reload
    fetch('/api/dashboard-update')
        .then(response => response.json())
        .then(data => {
            // Update widget contents with fresh data
            updateWidgetData(data);
        })
        .catch(error => {
            console.log('Dashboard update failed:', error);
        });
}, 300000); // 5 minutes

function updateWidgetData(data) {
    // Update various widgets with fresh data
    // This would update the displayed values without losing layout
    console.log('Dashboard data updated:', data);
}

// KPI Drill-Down Functionality
function showDrillDown(kpiType) {
    const modal = new bootstrap.Modal(document.getElementById('drillDownModal'));
    const modalTitle = document.getElementById('drillDownModalLabel');
    const modalContent = document.getElementById('drillDownContent');
    
    // Set modal title based on KPI type
    const titles = {
        'today-hours': 'Today\'s Hours Breakdown',
        'week-hours': 'This Week\'s Hours Breakdown',
        'leave-balance': 'Leave Balance Details',
        'total-staff': 'Total Staff Breakdown',
        'active-today': 'Active Employees Today',
        'overtime-hours': 'Overtime Hours Breakdown',
        'present-today': 'Present Employees Today'
    };
    
    modalTitle.textContent = titles[kpiType] || 'KPI Breakdown';
    
    // Show loading state
    modalContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ${titles[kpiType] || 'KPI breakdown'}...</p>
        </div>
    `;
    
    modal.show();
    
    // Fetch drill-down data
    fetch(`/api/drill-down/${kpiType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDrillDownData(kpiType, data.data);
            } else {
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Error Loading Data</h6>
                        <p>${data.error || 'Failed to load drill-down data'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            modalContent.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Network Error</h6>
                    <p>Failed to fetch drill-down data: ${error.message}</p>
                </div>
            `;
        });
}

function displayDrillDownData(kpiType, data) {
    const modalContent = document.getElementById('drillDownContent');
    let html = '';
    
    switch(kpiType) {
        case 'today-hours':
            html = generateTodayHoursBreakdown(data);
            break;
        case 'week-hours':
            html = generateWeekHoursBreakdown(data);
            break;
        case 'leave-balance':
            html = generateLeaveBalanceBreakdown(data);
            break;
        case 'total-staff':
            html = generateTotalStaffBreakdown(data);
            break;
        case 'active-today':
            html = generateActiveTodayBreakdown(data);
            break;
        case 'overtime-hours':
            html = generateOvertimeBreakdown(data);
            break;
        case 'present-today':
            html = generatePresentTodayBreakdown(data);
            break;
        default:
            html = '<div class="alert alert-info">No drill-down data available for this KPI.</div>';
    }
    
    modalContent.innerHTML = html;
    feather.replace();
}

function generateTodayHoursBreakdown(data) {
    if (!data.entries || data.entries.length === 0) {
        return '<div class="alert alert-info">No time entries found for today.</div>';
    }
    
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Calculation Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Hours:</strong><br>
                        <span class="h5 text-primary">${data.total_hours} hrs</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Regular Hours:</strong><br>
                        <span class="text-success">${data.regular_hours || 0} hrs</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Overtime Hours:</strong><br>
                        <span class="text-warning">${data.overtime_hours || 0} hrs</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Time Entries:</strong><br>
                        <span class="text-info">${data.entries.length}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>Time Entry Details</h6>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Clock In</th>
                        <th>Clock Out</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Break Time</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.entries.forEach(entry => {
        const duration = entry.total_hours || 0;
        const breakTime = entry.break_minutes || 0;
        html += `
            <tr>
                <td>${new Date(entry.clock_in_time).toLocaleTimeString()}</td>
                <td>${entry.clock_out_time ? new Date(entry.clock_out_time).toLocaleTimeString() : 'Still Active'}</td>
                <td>${duration.toFixed(2)} hrs</td>
                <td><span class="badge bg-${entry.status === 'Closed' ? 'success' : 'warning'}">${entry.status}</span></td>
                <td>${breakTime} min</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

function generateWeekHoursBreakdown(data) {
    if (!data.daily_breakdown) {
        return '<div class="alert alert-info">No time entries found for this week.</div>';
    }
    
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Weekly Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Total Hours:</strong><br>
                        <span class="h5 text-primary">${data.total_hours} hrs</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Average per Day:</strong><br>
                        <span class="text-success">${(data.total_hours / 7).toFixed(2)} hrs</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Days Worked:</strong><br>
                        <span class="text-info">${data.days_worked || 0}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>Daily Breakdown</h6>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Hours Worked</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.daily_breakdown.forEach(day => {
        const dayName = new Date(day.date).toLocaleDateString('en-US', { weekday: 'long' });
        html += `
            <tr>
                <td>${day.date}</td>
                <td>${dayName}</td>
                <td>${day.hours || 0} hrs</td>
                <td><span class="badge bg-${day.hours > 0 ? 'success' : 'secondary'}">${day.hours > 0 ? 'Worked' : 'No Entry'}</span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

function generateActiveTodayBreakdown(data) {
    if (!data.employees || data.employees.length === 0) {
        return '<div class="alert alert-info">No active employees found for today.</div>';
    }
    
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Active Employees Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Currently Active:</strong><br>
                        <span class="h5 text-success">${data.employees.length}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Total Clock-ins:</strong><br>
                        <span class="text-primary">${data.total_clock_ins || 0}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Average Start Time:</strong><br>
                        <span class="text-info">${data.average_start_time || 'N/A'}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>Active Employee Details</h6>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Clock In Time</th>
                        <th>Current Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.employees.forEach(emp => {
        html += `
            <tr>
                <td>${emp.full_name || emp.username}</td>
                <td>${emp.department || 'Not Assigned'}</td>
                <td>${new Date(emp.clock_in_time).toLocaleTimeString()}</td>
                <td>${emp.current_duration || 0} hrs</td>
                <td><span class="badge bg-success">Active</span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

function generateLeaveBalanceBreakdown(data) {
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Leave Balance Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Current Balance:</strong><br>
                        <span class="h5 text-primary">${data.current_balance || 0} days</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Annual Allowance:</strong><br>
                        <span class="text-success">${data.annual_allowance || 0} days</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Used This Year:</strong><br>
                        <span class="text-warning">${data.used_this_year || 0} days</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Pending Requests:</strong><br>
                        <span class="text-info">${data.pending_requests || 0} days</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <h6>How Balance is Calculated:</h6>
            <p><strong>Current Balance</strong> = Annual Allowance - Used This Year - Pending Requests</p>
            <p><strong>Calculation:</strong> ${data.annual_allowance || 0} - ${data.used_this_year || 0} - ${data.pending_requests || 0} = ${data.current_balance || 0} days</p>
        </div>
    `;
    
    return html;
}

function generateTotalStaffBreakdown(data) {
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Staff Breakdown by Role</h6>
            </div>
            <div class="card-body">
                <div class="row">
    `;
    
    if (data.by_role) {
        Object.entries(data.by_role).forEach(([role, count]) => {
            html += `
                <div class="col-md-3 mb-2">
                    <strong>${role}:</strong><br>
                    <span class="h6 text-primary">${count}</span>
                </div>
            `;
        });
    }
    
    html += `
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <h6>How Total Staff is Calculated:</h6>
            <p>Total includes all active users with assigned roles in the system.</p>
            <p><strong>Calculation:</strong> Sum of all active employees across all departments and roles.</p>
        </div>
    `;
    
    return html;
}

function generateOvertimeBreakdown(data) {
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Overtime Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Total OT Hours:</strong><br>
                        <span class="h5 text-warning">${data.total_overtime || 0} hrs</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Employees with OT:</strong><br>
                        <span class="text-primary">${data.employees_with_overtime || 0}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Average OT per Employee:</strong><br>
                        <span class="text-info">${data.average_overtime || 0} hrs</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <h6>How Overtime is Calculated:</h6>
            <p><strong>Overtime Hours</strong> = Any hours worked beyond 8 hours per day</p>
            <p><strong>Rate:</strong> 1.5x for first 2 hours, 2.0x for additional hours</p>
        </div>
    `;
    
    return html;
}

function generatePresentTodayBreakdown(data) {
    let html = `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Attendance Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Present Today:</strong><br>
                        <span class="h5 text-success">${data.present_count || 0}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Total Expected:</strong><br>
                        <span class="text-primary">${data.total_expected || 0}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Attendance Rate:</strong><br>
                        <span class="text-info">${data.attendance_rate || 0}%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <h6>How Attendance is Calculated:</h6>
            <p><strong>Present</strong> = Employees who have clocked in today</p>
            <p><strong>Attendance Rate</strong> = (Present / Total Expected) × 100</p>
        </div>
    `;
    
    return html;
}

function exportDrillDown() {
    // Export functionality could be implemented here
    alert('Export functionality coming soon!');
}
</script>

<!-- KPI Drill-Down Modal -->
<div class="modal fade" id="drillDownModal" tabindex="-1" aria-labelledby="drillDownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drillDownModalLabel">KPI Breakdown</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="drillDownContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading KPI breakdown...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportDrillDown()">
                    <i data-feather="download" class="me-2"></i>Export Data
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}