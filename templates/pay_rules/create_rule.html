{% extends "base.html" %}

{% block title %}Create Pay Rule - Flask PostgreSQL App{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i data-feather="plus" class="me-2"></i>
            Create Pay Rule
        </h2>
        <a href="{{ url_for('pay_rules.manage_pay_rules') }}" class="btn btn-outline-secondary">
            <i data-feather="arrow-left" class="me-2"></i>
            Back to Rules
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form method="POST" id="payRuleForm">
                        <!-- Basic Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Rule Name *</label>
                                            <input type="text" class="form-control" id="name" name="name" required>
                                            <div class="form-text">Unique name for this pay rule</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="priority" class="form-label">Priority</label>
                                            <input type="number" class="form-control" id="priority" name="priority" 
                                                   value="100" min="1" max="999">
                                            <div class="form-text">Lower numbers = higher priority</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                    <div class="form-text">Optional description of the rule purpose</div>
                                </div>
                            </div>
                        </div>

                        <!-- Rule Conditions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Conditions (When to Apply)</h5>
                            </div>
                            <div class="card-body">
                                <!-- Day of Week -->
                                <div class="mb-4">
                                    <label class="form-label">Days of Week</label>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="btn-group" role="group" data-bs-toggle="buttons">
                                                <input type="checkbox" class="btn-check" id="day_0" name="day_of_week" value="0">
                                                <label class="btn btn-outline-primary" for="day_0">Monday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_1" name="day_of_week" value="1">
                                                <label class="btn btn-outline-primary" for="day_1">Tuesday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_2" name="day_of_week" value="2">
                                                <label class="btn btn-outline-primary" for="day_2">Wednesday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_3" name="day_of_week" value="3">
                                                <label class="btn btn-outline-primary" for="day_3">Thursday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_4" name="day_of_week" value="4">
                                                <label class="btn btn-outline-primary" for="day_4">Friday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_5" name="day_of_week" value="5">
                                                <label class="btn btn-outline-primary" for="day_5">Saturday</label>
                                                
                                                <input type="checkbox" class="btn-check" id="day_6" name="day_of_week" value="6">
                                                <label class="btn btn-outline-primary" for="day_6">Sunday</label>
                                            </div>
                                            <div class="form-text">Select specific days when this rule applies (leave blank for all days)</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Time Range -->
                                <div class="mb-4">
                                    <label class="form-label">Time Range</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="start_hour" class="form-label">Start Hour</label>
                                            <select class="form-select" id="start_hour" name="start_hour">
                                                <option value="">Any time</option>
                                                {% for hour in range(24) %}
                                                <option value="{{ hour }}">{{ '%02d:00'|format(hour) }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="end_hour" class="form-label">End Hour</label>
                                            <select class="form-select" id="end_hour" name="end_hour">
                                                <option value="">Any time</option>
                                                {% for hour in range(24) %}
                                                <option value="{{ hour }}">{{ '%02d:00'|format(hour) }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-text">Time range when shifts must start to apply this rule</div>
                                </div>

                                <!-- Overtime Threshold -->
                                <div class="mb-4">
                                    <label for="overtime_threshold" class="form-label">Overtime Threshold (Hours)</label>
                                    <input type="number" class="form-control" id="overtime_threshold" name="overtime_threshold" 
                                           min="0" max="24" step="0.5" placeholder="e.g., 8.0">
                                    <div class="form-text">Apply rule only when daily hours exceed this threshold</div>
                                </div>

                                <!-- Employee Selection -->
                                <div class="mb-4">
                                    <label for="employee_ids" class="form-label">Specific Employees</label>
                                    <input type="text" class="form-control" id="employee_ids" name="employee_ids" 
                                           placeholder="e.g., 1,2,3">
                                    <div class="form-text">Comma-separated employee IDs (leave blank for all employees)</div>
                                </div>

                                <!-- Role Selection -->
                                <div class="mb-4">
                                    <label class="form-label">Employee Roles</label>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="role_employee" name="roles" value="Employee">
                                                <label class="form-check-label" for="role_employee">Employee</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="role_manager" name="roles" value="Manager">
                                                <label class="form-check-label" for="role_manager">Manager</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="role_admin" name="roles" value="Admin">
                                                <label class="form-check-label" for="role_admin">Admin</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="role_super" name="roles" value="Super User">
                                                <label class="form-check-label" for="role_super">Super User</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text">Apply rule only to employees with these roles (leave blank for all roles)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Rule Actions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Actions (What to Calculate)</h5>
                            </div>
                            <div class="card-body">
                                <!-- Pay Multiplier -->
                                <div class="mb-4">
                                    <label class="form-label">Pay Multiplier</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="pay_multiplier" class="form-label">Multiplier</label>
                                            <input type="number" class="form-control" id="pay_multiplier" name="pay_multiplier" 
                                                   min="0.1" max="10" step="0.1" placeholder="e.g., 1.5">
                                            <div class="form-text">Multiply applicable hours by this factor</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="component_name" class="form-label">Component Name</label>
                                            <input type="text" class="form-control" id="component_name" name="component_name" 
                                                   placeholder="e.g., overtime_1_5">
                                            <div class="form-text">Name for this pay component</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Flat Allowance -->
                                <div class="mb-4">
                                    <label class="form-label">Flat Allowance</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="flat_allowance" class="form-label">Amount ($)</label>
                                            <input type="number" class="form-control" id="flat_allowance" name="flat_allowance" 
                                                   min="0" step="0.01" placeholder="e.g., 25.00">
                                            <div class="form-text">Fixed dollar amount per occurrence</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="allowance_name" class="form-label">Allowance Name</label>
                                            <input type="text" class="form-control" id="allowance_name" name="allowance_name" 
                                                   placeholder="e.g., meal_allowance">
                                            <div class="form-text">Name for this allowance</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shift Differential -->
                                <div class="mb-4">
                                    <label class="form-label">Shift Differential</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="shift_differential" class="form-label">Differential ($/hour)</label>
                                            <input type="number" class="form-control" id="shift_differential" name="shift_differential" 
                                                   min="0" step="0.01" placeholder="e.g., 2.00">
                                            <div class="form-text">Additional amount per hour worked</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="differential_name" class="form-label">Differential Name</label>
                                            <input type="text" class="form-control" id="differential_name" name="differential_name" 
                                                   placeholder="e.g., night_differential">
                                            <div class="form-text">Name for this differential</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('pay_rules.manage_pay_rules') }}" class="btn btn-secondary">
                                <i data-feather="x" class="me-2"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="save" class="me-2"></i>
                                Create Pay Rule
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Example Rules Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Example Rules</h6>
                </div>
                <div class="card-body">
                    {% for key, rule in example_rules.items() %}
                    <div class="card mb-3">
                        <div class="card-body p-3">
                            <h6 class="card-title">{{ rule.name }}</h6>
                            <p class="card-text small">{{ rule.description }}</p>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="loadExample('{{ key }}')">
                                Use This Example
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Rule Configuration Help</h6>
                </div>
                <div class="card-body">
                    <h6>Conditions</h6>
                    <ul class="small">
                        <li><strong>Days:</strong> Rule applies only on selected days</li>
                        <li><strong>Time:</strong> Rule applies to shifts starting in time range</li>
                        <li><strong>Overtime:</strong> Rule applies when daily hours exceed threshold</li>
                        <li><strong>Employees:</strong> Rule applies to specific employee IDs</li>
                        <li><strong>Roles:</strong> Rule applies to employees with specific roles</li>
                    </ul>
                    
                    <h6 class="mt-3">Actions</h6>
                    <ul class="small">
                        <li><strong>Multiplier:</strong> Multiply hours by factor (e.g., 1.5x for overtime)</li>
                        <li><strong>Allowance:</strong> Add fixed dollar amount</li>
                        <li><strong>Differential:</strong> Add amount per hour worked</li>
                    </ul>
                    
                    <div class="alert alert-info small mt-3">
                        <strong>Note:</strong> At least one condition and one action must be specified. Rules are processed in priority order (lower number = higher priority).
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    feather.replace();
    
    function loadExample(ruleType) {
        fetch(`/pay-rules/api/examples/${ruleType}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading example: ' + data.error);
                    return;
                }
                
                // Fill in basic info
                document.getElementById('name').value = data.name;
                document.getElementById('description').value = data.description;
                document.getElementById('priority').value = data.priority;
                
                // Clear existing selections
                clearForm();
                
                // Set conditions
                const conditions = data.conditions;
                
                if (conditions.day_of_week) {
                    conditions.day_of_week.forEach(day => {
                        const checkbox = document.getElementById(`day_${day}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                if (conditions.time_range) {
                    document.getElementById('start_hour').value = conditions.time_range.start;
                    document.getElementById('end_hour').value = conditions.time_range.end;
                }
                
                if (conditions.overtime_threshold) {
                    document.getElementById('overtime_threshold').value = conditions.overtime_threshold;
                }
                
                if (conditions.roles) {
                    conditions.roles.forEach(role => {
                        const checkbox = document.querySelector(`input[name="roles"][value="${role}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Set actions
                const actions = data.actions;
                
                if (actions.pay_multiplier) {
                    document.getElementById('pay_multiplier').value = actions.pay_multiplier;
                    document.getElementById('component_name').value = actions.component_name || '';
                }
                
                if (actions.flat_allowance) {
                    document.getElementById('flat_allowance').value = actions.flat_allowance;
                    document.getElementById('allowance_name').value = actions.allowance_name || '';
                }
                
                if (actions.shift_differential) {
                    document.getElementById('shift_differential').value = actions.shift_differential;
                    document.getElementById('differential_name').value = actions.differential_name || '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while loading the example.');
            });
    }
    
    function clearForm() {
        // Clear checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // Clear selects
        document.querySelectorAll('select').forEach(select => select.value = '');
        
        // Clear number inputs (but not name/description)
        document.querySelectorAll('input[type="number"]').forEach(input => {
            if (input.id !== 'priority') input.value = '';
        });
    }
    
    // Form validation
    document.getElementById('payRuleForm').addEventListener('submit', function(e) {
        const conditions = getFormConditions();
        const actions = getFormActions();
        
        if (Object.keys(conditions).length === 0) {
            e.preventDefault();
            alert('Please specify at least one condition.');
            return;
        }
        
        if (Object.keys(actions).length === 0) {
            e.preventDefault();
            alert('Please specify at least one action.');
            return;
        }
    });
    
    function getFormConditions() {
        const conditions = {};
        
        // Days
        const selectedDays = Array.from(document.querySelectorAll('input[name="day_of_week"]:checked'))
            .map(cb => parseInt(cb.value));
        if (selectedDays.length > 0) conditions.day_of_week = selectedDays;
        
        // Time range
        const startHour = document.getElementById('start_hour').value;
        const endHour = document.getElementById('end_hour').value;
        if (startHour && endHour) {
            conditions.time_range = { start: parseInt(startHour), end: parseInt(endHour) };
        }
        
        // Overtime
        const overtime = document.getElementById('overtime_threshold').value;
        if (overtime) conditions.overtime_threshold = parseFloat(overtime);
        
        // Employees
        const employees = document.getElementById('employee_ids').value;
        if (employees) {
            conditions.employee_ids = employees.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
        }
        
        // Roles
        const selectedRoles = Array.from(document.querySelectorAll('input[name="roles"]:checked'))
            .map(cb => cb.value);
        if (selectedRoles.length > 0) conditions.roles = selectedRoles;
        
        return conditions;
    }
    
    function getFormActions() {
        const actions = {};
        
        const multiplier = document.getElementById('pay_multiplier').value;
        if (multiplier) actions.pay_multiplier = parseFloat(multiplier);
        
        const allowance = document.getElementById('flat_allowance').value;
        if (allowance) actions.flat_allowance = parseFloat(allowance);
        
        const differential = document.getElementById('shift_differential').value;
        if (differential) actions.shift_differential = parseFloat(differential);
        
        return actions;
    }
</script>
{% endblock %}